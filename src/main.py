# src/main.py

from src.scanner import NmapScanner
from src.service_detector import ServiceDetector
from src.vulnerability_checker import VulnerabilityChecker
from src.network_mapper import NetworkMapper
from src.report_generator import ReportGenerator

def main(target_ip):
    # Step 1: Scan Ports
    scanner = NmapScanner()
    scanned_ports = scanner.scan_ports(target_ip)

    # Step 2: Detect Services
    service_detector = ServiceDetector(scanned_ports)
    services = service_detector.detect_services()

    # Step 3: Check for Vulnerabilities
    vulnerability_checker = VulnerabilityChecker()
    vulnerabilities = {}
    for port, service in services.items():
        result = vulnerability_checker.check_vulnerability(service["name"], service["version"])
        if result:
            vulnerabilities[port] = result

    # Step 4: Map Network
    network_mapper = NetworkMapper()
    network_devices = network_mapper.map_network(target_ip)

    # Step 5: Generate Report
    report_generator = ReportGenerator("Network Vulnerability Report")
    report_content = f"Scanned IP: {target_ip}\n\n"
    report_content += "Services:\n"
    for port, service in services.items():
        report_content += f"Port {port}: {service['name']} (Version: {service['version']})\n"

    if vulnerabilities:
        report_content += "\nVulnerabilities Found:\n"
        for port, vuln in vulnerabilities.items():
            report_content += f"Port {port}: {vuln}\n"

    report_content += "\nNetwork Devices:\n"
    for device in network_devices:
        report_content += f"IP: {device['ip']}, MAC: {device['mac']}\n"

    report_generator.add_page(report_content)
    report_generator.save("network_vulnerability_report.pdf")
    print("Report generated: network_vulnerability_report.pdf")

if __name__ == "__main__":
    target_ip = input("Enter the target IP address: ")
    main(target_ip)

